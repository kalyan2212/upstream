name: Deploy Upstream App to Azure
# ─────────────────────────────────────────────────────────────────────────────
# Triggers: every push to main branch
# Steps:
#   1. Provision Azure infrastructure with Terraform
#   2. Deploy app files to both VMs via SSH
#   3. Restart the Streamlit service on each VM
# ─────────────────────────────────────────────────────────────────────────────

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:          # allow manual trigger from GitHub UI

env:
  # Terraform Azure backend auth
  ARM_CLIENT_ID:       ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET:   ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID:       ${{ secrets.AZURE_TENANT_ID }}
  # Terraform variables
  TF_VAR_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  TF_VAR_ssh_public_key:  ${{ secrets.SSH_PUBLIC_KEY }}
  TF_VAR_vm_size:         "Standard_B2s"

jobs:
  # ── Job 1: Terraform ────────────────────────────────────────────────────────
  terraform:
    name: Provision Infrastructure
    runs-on: ubuntu-latest
    outputs:
      vm1_ip: ${{ steps.tf_out.outputs.vm1_ip }}
      vm2_ip: ${{ steps.tf_out.outputs.vm2_ip }}
      lb_ip:  ${{ steps.tf_out.outputs.lb_ip }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Validate
        working-directory: terraform
        run: terraform validate

      - name: Terraform Plan
        working-directory: terraform
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve tfplan

      - name: Capture Terraform Outputs
        id: tf_out
        working-directory: terraform
        run: |
          echo "vm1_ip=$(terraform output -raw vm1_public_ip)" >> "$GITHUB_OUTPUT"
          echo "vm2_ip=$(terraform output -raw vm2_public_ip)" >> "$GITHUB_OUTPUT"
          echo "lb_ip=$(terraform output -raw lb_public_ip)"   >> "$GITHUB_OUTPUT"

      - name: Print App URL
        working-directory: terraform
        run: |
          echo "=============================================="
          echo " App is accessible at: $(terraform output -raw app_url)"
          echo "=============================================="

  # ── Job 2: Deploy App ───────────────────────────────────────────────────────
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: terraform

    strategy:
      matrix:
        vm_ip:
          - ${{ needs.terraform.outputs.vm1_ip }}
          - ${{ needs.terraform.outputs.vm2_ip }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ matrix.vm_ip }}" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Wait for VM SSH to be ready
        run: |
          for i in $(seq 1 20); do
            ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no \
              azureuser@${{ matrix.vm_ip }} "echo ready" && break
            echo "Attempt $i: SSH not ready yet, retrying in 15s..."
            sleep 15
          done

      - name: Copy app files to VM
        run: |
          scp -o StrictHostKeyChecking=no \
            upstream_streamlit.py \
            upstream_integration.py \
            requirements.txt \
            azureuser@${{ matrix.vm_ip }}:/opt/upstream/app/

      - name: Install dependencies & restart service
        run: |
          ssh -o StrictHostKeyChecking=no azureuser@${{ matrix.vm_ip }} << 'REMOTE'
            set -e
            echo "==> Installing Python dependencies..."
            /opt/upstream/venv/bin/pip install -r /opt/upstream/app/requirements.txt --quiet

            echo "==> Restarting upstream service..."
            sudo systemctl restart upstream

            echo "==> Service status:"
            sudo systemctl is-active upstream

            echo "==> Deploy complete on $(hostname)"
          REMOTE

      - name: Health check
        run: |
          sleep 5
          ssh -o StrictHostKeyChecking=no azureuser@${{ matrix.vm_ip }} \
            "curl -sf http://localhost:8501/_stcore/health && echo 'Health OK' || echo 'Health check failed'"
